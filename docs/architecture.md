# Архитектура сервиса

## Обзор
Сервис — это однопроцессный Python-скрипт, работающий в Docker. Он читает строки из Google Sheets, генерирует контент через OpenAI, создает товары в WooCommerce (с вариациями и атрибутами), публикует переводы и обновляет статус обработки.

## Основные компоненты
- `run/main.py`: оркестрация пайплайна, расписание запуска, логирование.
- `run/_1_google_loader.py`: доступ к Google Sheets, кеширование, обновления ячеек.
- `run/_2_content_generation.py`: извлечение текста, вызовы OpenAI, генерация изображений, геокодинг.
- `run/prompts/*.txt`: системные промпты для Responses API.
- `run/_3_create_product.py`: создание товара и категорий в WooCommerce, JWT токен.
- `run/_4_create_translation.py`: создание перевода товара и привязка через WPML API.
- `run/_5_taxonomy_and_attributes.py`: создание атрибутов и терминов, назначение атрибутов товару.
- `run/_6_create_variations.py`: создание вариаций товара с проверкой дубликатов.
- `run/utils.py`: вспомогательные функции, включая нормализацию атрибутов.

## Поток данных
1. `main.py` читает строки из Google Sheets.
2. Для строк со статусом `revised` собираются данные, геокодинг, и извлекается текст сайтов/регламентов; HTML-страницы регламента передаются как REGULATIONS INFO.
3. OpenAI генерирует структуру контента и, при необходимости, изображение.
4. Второй ассистент очищает `org_info` и `benefits`, удаляя пустые блоки и общие локации без конкретики.
5. Создается товар в WooCommerce, назначаются категории, атрибуты и вариации.
6. Создается перевод товара (PT) и связывается через WPML API.
7. В Google Sheets обновляется статус и вспомогательные поля.

## Интеграции
- Google Sheets API (gspread + Service Account).
- OpenAI Responses API (генерация текста) и OpenAI Images API (генерация изображений).
- OpenCage Geocoding API.
- WooCommerce REST API, WordPress JWT Auth, WPML custom API.

## Конфигурация
- Все параметры задаются через `.env` (см. `.env.example`).
- Модели, уровень размышления, температура и пути к промптам задаются через переменные `OPENAI_*`.
- Системный промпт первого ассистента требует строгой валидации фактов на основе WEBSITE INFO, REGULATIONS INFO и PDF, допускает меньше 2 абзацев при недостатке данных, исключает блоки org_info без данных, запрещает любые заголовки вне заданного списка org_info и задает приоритет PDF при расхождениях.
- Системный промпт второго ассистента удаляет блоки без значения и общие локации; примеры в тексте промпта не являются обязательными.
- Системный промпт второго ассистента удаляет любые блоки org_info/org_info_pt с заголовками вне явного списка (EN и PT эквиваленты) и жёстко удаляет ссылки на регламент при пустом REGULATIONS LINK.
- Перед назначением атрибутов продукта значения нормализуются к спискам, чтобы избежать ошибок при объединении.
- Системный промпт второго ассистента удаляет строку "[]" из org_info/org_info_pt и элементы "[]" из benefits/benefits_pt.
- Файл `run/google-credentials.json` монтируется в контейнер и используется для доступа к Google API.
- Запросы к сайтам и регламентам выполняются с заголовками User-Agent/Accept/Accept-Language и ретраями с задержками, заданными через `HTTP_FETCH_*`.
- При неудачном парсинге WEBSITE или REGULATIONS строка помечается ошибкой в STATUS и дальнейшая генерация/публикация пропускается.
- Формат блока Regulation link ↗ нормализуется после первого ассистента, чтобы гарантировать единый HTML-шаблон ссылки.
- Запросы WooCommerce для вариаций выполняются с ретраями и таймаутом, параметры задаются через `WCAPI_*`.
- Логи пишутся в stdout контейнера и дублируются в файл, путь задается через `LOG_FILE`.

## Развертывание
- Запуск через `docker-compose.yml`.
- Планировщик в `main.py` управляет периодическим запуском по расписанию.
